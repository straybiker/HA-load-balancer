alias: Set EV charging parameter
variables:
  config: !include cars/ev_loadbalancer_config.yaml
sequence:
  - variables:
      finalcurrent: |-
        {% if current < 6 %}
          0
        {% else %}
          {{ current }}
        {% endif %}
  - parallel:
      - alias: Set phases
        if:
          - condition: template
            value_template: "{{ has_value(config.charger.phase_select) }}"
          - alias: If phase change
            condition: template
            value_template: "{{ phase != states(config.charger.phase_select) }}"
        then:
          - action: system_log.write
            data:
              level: info
              message: "Changing phase from {{ states(config.charger.phase_select) }} to {{ phase }}"
          - action: logbook.log
            data:
              message: "Changing phase from {{ states(config.charger.phase_select) }} to {{ phase }}"
              entity_id: "{{ config.charger.phase_select }}"
              name: Alfen Phases
          - action: select.select_option
            data:
              option: "{{ phase }}"
            target:
              entity_id: "{{ config.charger.phase_select }}"
          # Allow the relay switching to complete and stabilize
          - delay:
              seconds: 10
            enabled: true
      - alias: Set current
        if:
          - condition: template
            value_template: "{{ has_value(config.charger.current) }}"
          - condition: template
            value_template: "{{ finalcurrent | int != states(config.charger.current) | int }}"
            enabled: true
        then:
          - action: system_log.write
            data:
              level: info
              message: "Changing current from {{ states(config.charger.current) }} to {{ finalcurrent }}"
          - action: logbook.log
            data:
              message: "Changing current from {{ states(config.charger.current) }} to {{ finalcurrent }}"
              entity_id: "{{ config.charger.current }}"
              name: Alfen Current
          - action: number.set_value
            data:
              value: "{{ finalcurrent }}"
            target:
              entity_id: "{{ config.charger.current }}"
          # Allow the current change to settle
          - delay:
              seconds: 5
            enabled: true
description: Set the Alfen Eve Pro current and phase
icon: mdi:ev-station
fields:
  phase:
    selector:
      select:
        options:
          - 1 Phase
          - 3 Phases
        multiple: false
    name: phase
    required: false
    description: EV charging phase [1 Phase, 3 Phases]
    default: 1 Phase
  current:
    selector:
      number:
        min: 0
        max: 16
        step: 1
    name: current
    required: true
    default: 6
    description: EV charging current
mode: single
