# Package configuration for EV load balancing
# Check the documentation for more details: https://github.com/straybiker/HA-load-balancer

###################################################################################
## CONFIGURATION
## The configuration has been moved to ev_loadbalancer_user_config.yaml
## Please check that file to update your settings.
###################################################################################

###################################################################################
## INPUTS
## Helper definitions for the load balancer. These can be controlled via the UI.
## If no control from the UI is needed, the settings can be hardcoded in the
## configuration section above.
###################################################################################

input_select:
  ## Mandatory input
  ev_load_balancer_charge_mode:
    name: EV Load Balancer Charge Mode
    icon: mdi:ev-station
    options:
      - "Off"
      - "1-Phase Minimum"
      - "3-Phases Minimum"
      - "Limited"
      - "Fast"
      - "Solar"
      - "Comfort"

input_boolean:
  ## Mandatory input
  ev_load_balancer_pv_prioritized:
    name: EV Load Balancer Limited PV Prioritized
    icon: mdi:solar-power

  ev_load_balancer_car_aware:
    ## Mandatory input
    name: EV Load Balancer Car Aware
    icon: mdi:car-electric

  ev_load_balancer_single_phase_only:
    name: EV Load Balancer Single Phase Only
    icon: mdi:numeric-1-box

  ev_load_balancer_ems_control:
    name: EV Load Balancer EMS Mode Control
    icon: mdi:home-lightning-bolt-outline

  ev_load_balancer_ems_as_onoff:
    name: EV Load Balancer EMS as on/off
    icon: mdi:toggle-switch

input_number:
  ## Mandatory input
  ev_load_balancer_power_limit:
    name: EV Load Balancer Power Limit
    icon: mdi:flash
    mode: slider
    unit_of_measurement: W
    min: 1500
    max: 12000
    step: 100

  ## Optional input: can be removed if car aware is not used
  ev_load_balancer_target_soc:
    name: EV Load Balancer SOC Target
    icon: mdi:battery-charging-80
    mode: slider
    unit_of_measurement: "%"
    initial: 80
    min: 0
    max: 100
    step: 1

  ## Optional input: can be removed if Comfort mode is not used
  ev_load_balancer_comfort_soc:
    name: EV Load Balancer SOC Comfort Minimum
    icon: mdi:battery-charging-50
    mode: slider
    unit_of_measurement: "%"
    initial: 50
    min: 0
    max: 100
    step: 1

  ev_load_balancer_emergency_soc:
    name: EV Load Balancer SOC Floor
    icon: mdi:battery-alert
    unit_of_measurement: "%"
    mode: slider
    initial: 20
    min: 0
    max: 100
    step: 1

  ev_max_charging_cost:
    name: Max charging cost
    icon: mdi:cash-check
    initial: 0.30
    min: 0.10
    max: 0.50
    step: 0.01
    unit_of_measurement: "â‚¬/kWh"

input_datetime:
  ## Optional input: can be removed if car aware is not used
  ev_load_balancer_charge_time_target:
    name: EV Load Balancer Charge Time Target
    icon: mdi:clock-time-four-outline
    has_date: false
    has_time: true

###################################################################################
## END INPUTS
###################################################################################

template:
  - sensor:
      - name: "EV Load Balancer Internal Phase Monitor"
        unique_id: ev_load_balancer_internal_phase_monitor
        state: >
          {% set phases_entity = state_attr('sensor.ev_load_balancer_charger', 'phases_output') %}
          {{ states(phases_entity) if phases_entity else 'unknown' }}

timer:
  ev_load_balancer_phase_switching_timer:
    name: EV Load Balancer Phase Switching Timer
    icon: mdi:timer
    duration: "00:05:00"
    restore: true

script:
  ev_load_balancer_set_charger_params:
    alias: Set EV load balancer charger parameter
    variables:
      charger: "{{ states('sensor.ev_load_balancer_charger') }}"
      car_aware: "{{ state_attr('sensor.ev_load_balancer', 'car_aware') }}"
      phase_1: "{{ state_attr('sensor.ev_load_balancer_charger', 'phase_1_state') | default('1 Phase', true) }}"
      phase_3: "{{ state_attr('sensor.ev_load_balancer_charger', 'phase_3_state') | default('3 Phases', true) }}"
      min_current: >
        {% set charger_min_current = state_attr('sensor.ev_load_balancer_charger', 'min_current') %}
        {% set car_min_current = state_attr('sensor.ev_load_balancer_car', 'min_current') %}
        {{ [car_min_current if car_aware else charger_min_current, charger_min_current] | max }}
    sequence:
      - variables:
          finalcurrent: "{{ 0 if current < min_current else current }}"
          phase: "{{ phase_3 if phase|int == 3 else phase_1 }}"
      # First handle any needed phase changes
      - if:
          - condition: template
            value_template: >
              {{ has_value(state_attr('sensor.ev_load_balancer_charger','phases_output')) and
                phase != states(state_attr('sensor.ev_load_balancer_charger','phases_output')) }}
        then:
          # Step 1: Set current to 0 first (only when switching from 1 to 3 phases)
          - if:
              - condition: template
                value_template: >
                  {{ states(state_attr('sensor.ev_load_balancer_charger','phases_output')) == phase_1 and phase == phase_3 }}
            then:
              - variables:
                  max_delays: 30
              - alias: "Set current to 0 before phase change (1->3 phase)"
                action: number.set_value
                target:
                  entity_id: "{{ state_attr('sensor.ev_load_balancer_charger','current_output') }}"
                data:
                  value: 0
              # Wait for current to reach 0
              - alias: "Wait for current to reach 0"
                repeat:
                  sequence:
                    - delay:
                        seconds: 1
                  until:
                    - condition: template
                      value_template: >
                        {{ state_attr('sensor.ev_load_balancer_charger','current_input') | int == 0 or
                          repeat.index >= max_delays }}
          # Step 2: Change phases
          - alias: "Change phases"
            action: system_log.write
            data:
              level: info
              message: "[Pkg] Changing phase from {{ state_attr('sensor.ev_load_balancer_charger', 'phases_input') }} to {{ phase }}"
          - action: select.select_option
            target:
              entity_id: "{{ state_attr('sensor.ev_load_balancer_charger','phases_output') }}"
            data:
              option: "{{ phase }}"
          # Wait for phase change to complete
          - variables:
              max_delays: 60
          - alias: "Wait for phase change"
            repeat:
              sequence:
                - delay:
                    seconds: 1
              until:
                - condition: template
                  value_template: >
                    {{ state_attr('sensor.ev_load_balancer_charger', 'phases_input') == phase or repeat.index >= max_delays }}
      # After phase change or if no phase change needed, set the final current
      # Set the final current if needed
      - if:
          - condition: template
            value_template: "{{ has_value(state_attr('sensor.ev_load_balancer_charger','current_output')) }}"
          - condition: template
            value_template: >
              {% set power_threshold = state_attr('sensor.ev_load_balancer', 'power_update_threshold') | float(230) %}
              {% set voltage = state_attr('sensor.ev_load_balancer_charger', 'nominal_voltage') | float(230) %}
              {% set phases = 3 if '3' in (phase|string) else 1 %}
              {% set current_threshold = power_threshold / (voltage * phases) %}
              {% set current_value = states(state_attr('sensor.ev_load_balancer_charger','current_output')) | float(0) %}
              {% set difference = (finalcurrent | float - current_value) | abs %}
              {{ difference >= current_threshold }}
        then:
          - action: system_log.write
            data:
              level: info
              message: "[Pkg] Changing current from {{ state_attr('sensor.ev_load_balancer_charger', 'current_input') }} to {{ finalcurrent }}"
          - action: number.set_value
            target:
              entity_id: "{{ state_attr('sensor.ev_load_balancer_charger','current_output') }}"
            data:
              value: "{{ finalcurrent }}"
          # Wait for current change to complete
          - variables:
              max_delays: 30
          - repeat:
              sequence:
                - delay:
                    seconds: 1
              until:
                - condition: template
                  value_template: >
                    {% set power_threshold = state_attr('sensor.ev_load_balancer', 'power_update_threshold') | float(230) %}
                    {% set voltage = state_attr('sensor.ev_load_balancer_charger', 'nominal_voltage') | float(230) %}
                    {% set phases = 3 if '3' in (phase|string) else 1 %}
                    {% set current_threshold = power_threshold / (voltage * phases) %}
                    {% set current_diff = (state_attr('sensor.ev_load_balancer_charger','current_input') | float(99) - finalcurrent | float) | abs %}
                    {{ current_diff < current_threshold or repeat.index >= max_delays }}
    description: Set the charger current and phase
    fields:
      phase:
        selector:
          select:
            options:
              - "1"
              - "3"
            multiple: false
        name: phase
        required: false
        description: EV charging phase [1 Phase, 3 Phases] (input as integer 1 or 3)
        default: 1
      current:
        selector:
          number:
            min: 0
            max: 16
            step: 0.1
        name: current
        required: true
        default: 6.0
        description: EV charging current (float)
    mode: single

automation:
  - alias: EV Charging Load Balancer
    id: load_balance_ev_charging
    description: "Generic EMS Budgeting with Max Cost Guard, Solar Turbo, and Efficiency Compensation"

    triggers:
      - trigger: time_pattern
        seconds: /10
    conditions:
      - condition: template
        value_template: "{{ (state_attr('automation.load_balance_ev_charging', 'current') == 0) | bool }}"
      - condition: template
        value_template: "{{ state_attr('sensor.ev_load_balancer_charger','connection_state') == 'Connected' }}"
      - condition: template
        value_template: |-
          {{ has_value( state_attr('sensor.ev_load_balancer_charger','phases_output')) and 
          has_value( state_attr('sensor.ev_load_balancer_charger','current_output')) }}
      - condition: template
        value_template: "{{ state_attr('sensor.ev_load_balancer','power_limit') | int > 0 }}"
    actions:
      - variables:
          # --- 1. SENSOR STATES WITH ATTRIBUTES ---
          household_power: "{{ states('sensor.ev_load_balancer_house') | int }}"
          charger_current_input: "{{ state_attr('sensor.ev_load_balancer_charger','current_input') | float(0) }}"
          charger_power: "{{ state_attr('sensor.ev_load_balancer_charger','active_power') | float(0) }}"
          charger_phases_input: "{{ state_attr('sensor.ev_load_balancer_charger','phases_input') }}"
          grid_power_limit: "{{ state_attr('sensor.ev_load_balancer','power_limit') | int }}"
          nominal_voltage: "{{ state_attr('sensor.ev_load_balancer_charger','nominal_voltage') | int(230) }}"
          phase_1: "{{ state_attr('sensor.ev_load_balancer_charger', 'phase_1_state') | default('1 Phase', true) }}"
          phase_3: "{{ state_attr('sensor.ev_load_balancer_charger', 'phase_3_state') | default('3 Phases', true) }}"
          selected_mode: "{{ states('sensor.ev_load_balancer') }}"

          # --- 2. CAR AWARE HARDWARE LIMITS ---
          car_aware: >
            {% set car_aware_flag = state_attr('sensor.ev_load_balancer', 'car_aware') | bool %}
            {% if not car_aware_flag %} false
            {% else %}
              {% set required_sensors = [
                state_attr('sensor.ev_load_balancer_car','battery_capacity_wh'),
                state_attr('sensor.ev_load_balancer_car','battery_percentage'),
                state_attr('sensor.ev_load_balancer_car','soc_threshold')
              ] %}
              {{ required_sensors | select('in', ['unavailable', 'unknown', None, 'none', 'None', '']) | list | count == 0 }}
            {% endif %}

          max_current: >
            {% set charger_max = state_attr('sensor.ev_load_balancer_charger', 'max_current') | int %}
            {% set car_max = state_attr('sensor.ev_load_balancer_car', 'max_current') | int %}
            {{ [car_max, charger_max] | min if car_aware else charger_max }}

          min_current: >
            {% set charger_min = state_attr('sensor.ev_load_balancer_charger', 'min_current') %}
            {% set car_min = state_attr('sensor.ev_load_balancer_car', 'min_current') %}
            {{ [car_min, charger_min] | max if car_aware else charger_min }}

          # Efficiency Compensation
          charger_efficiency: >
            {% set phase_count = 3 if charger_phases_input == phase_3 else 1 %}
            {% if charger_current_input > 0 and charger_power > 1000.0 %}
              {% set eff = charger_power / (charger_current_input * nominal_voltage * phase_count) %}
              {{ [eff, 1.0] | min }}
            {% else %}
              1.0
            {% endif %}

          # --- 3. EMS & MAX COST GUARDS ---
          current_rate: "{{ states('sensor.current_electricity_cost_dynamic_rate') | float(0) }}"
          max_cost_rate: "{{ states('input_number.ev_max_charging_cost') | float(0.30) }}"
          ems_active: "{{ states('input_boolean.ev_load_balancer_ems_control') == 'on' }}"

          ems_signal: "{{ state_attr('sensor.ev_load_balancer', 'ems_signal') | float(0) > 0 }}"
          ems_as_onoff: "{{ state_attr('sensor.ev_load_balancer', 'ems_as_onoff') | bool }}"

          current_soc: "{{ state_attr('sensor.ev_load_balancer_car', 'battery_percentage') | int(100) }}"
          emergency_soc: "{{ states('input_number.ev_load_balancer_emergency_soc') | int(20) }}"
          target_soc: "{{ states('input_number.ev_load_balancer_target_soc') | int(80) }}"
          comfort_soc: "{{ states('input_number.ev_load_balancer_comfort_soc') | int(50)}}"

          # Safety Floor Overrides ALL EMS/Price rules
          is_emergency: "{{ current_soc < emergency_soc }}"

          # Grid Gate determines if we buy from Grid or ONLY scavenge Solar Surplus
          grid_gate_open: >
            {% if is_emergency %} true
            {% else %}
              {% set price_ok = current_rate <= max_cost_rate %}
              {% set signal_ok = (not ems_active) or ems_signal %}
              {{ price_ok and signal_ok }}
            {% endif %}

          # --- 4. INTENT: DESIRED GRID WATTAGE ---
          # What the selected mode theoretically wants (before EMS shaving)
          desired_grid_w: >
            {% set p_min_1 = min_current * nominal_voltage * 1 %}
            {% set p_min_3 = min_current * nominal_voltage * 3 %}
            {% set p_fast = max_current * nominal_voltage * 3 %}

            {% if selected_mode == 'Off' %} 0
            {% elif is_emergency %} {{ grid_power_limit }} {# Emergency bypasses everything to get you to safety #}
            {% elif not grid_gate_open %} 0 {# Blocked by Price/EMS #}
            {% elif selected_mode == '1-Phase Minimum' %} {{ p_min_1 }}
            {% elif selected_mode == '3-Phases Minimum' %} {{ p_min_3 }}
            {% elif selected_mode == 'Fast' %} {{ p_fast }}
            {% elif selected_mode == 'Limited' %} {{ grid_power_limit }}
            {% elif selected_mode == 'Comfort' %} 
               {{ grid_power_limit if current_soc < comfort_soc else 0 }}
            {% elif selected_mode == 'Solar' %} 0 {# Explicitly 0 Grid for Solar #}
            {% else %} 0
            {% endif %}

          # --- 5. CONSTRAINT: EMS PEAK SHAVING ---
          # Apply the EMS budget to dynamic modes (Static modes bypass this shave)
          ems_budget_w: "{{ state_attr('sensor.ev_load_balancer', 'ems_signal') | float(0) }}"

          effective_grid_w: >
            {% if is_emergency %}
              {{ desired_grid_w }} {# Ignore EMS shaving in an emergency #}
            {% elif selected_mode == 'Solar' %}
              0 {# Explicitly enforce 0 Grid #}
            {% elif ems_active and selected_mode in ['Limited', 'Comfort'] and ems_as_onoff == false %}
              {{ [desired_grid_w, ems_budget_w] | min }} {# Shave grid request to match EMS Budget #}
            {% else %}
              {{ desired_grid_w }} {# Static modes or EMS off #}
            {% endif %}

          # Simulated proxy for Battery % calculation based on shaved grid + surplus
          pv_prioritized: "{{ state_attr('sensor.ev_load_balancer', 'pv_prioritized')}}"
          raw_target_power: >
            {% set solar_surplus = [-household_power, 0] | max %}
            {% if selected_mode == 'Off' %} 0
            {% elif selected_mode == 'Limited' and pv_prioritized and solar_surplus > 0 %} {{ solar_surplus }}
            {% else %} {{ effective_grid_w + solar_surplus }}
            {% endif %}

          proxy_phase: "{{ 3 if raw_target_power >= (min_current * nominal_voltage * 3) else 1 }}"
          proxy_current: >
            {% set current = (raw_target_power / (nominal_voltage * proxy_phase)) | int %}
            {% if current < min_current %} 0
            {% elif current > max_current %} {{ max_current }}
            {% else %} {{ current }} {% endif %}

          # --- 7. PHYSICAL CONSTRAINT: FUSE LIMIT WITH EFFICIENCY ---
          adjusted_available_power_final: |
            {% set grid_headroom = (grid_power_limit - household_power) | float %}
            {% set max_hardware = max_current * nominal_voltage * 3 %}

            {# Adjust physical targets up to compensate for charger hardware losses #}
            {% set raw_target_eff = raw_target_power / charger_efficiency %}
            {% set headroom_adjusted = (grid_headroom / charger_efficiency) if grid_headroom > 0 else 0 %}

            {{ [raw_target_eff, headroom_adjusted, max_hardware] | min }}

          # --- 8. HARDWARE SELECTION (Phase & Amps) ---
          adjusted_phase_selection: >
            {% set force_single = state_attr('sensor.ev_load_balancer', 'single_phase_only') | bool %}
            {% set p_min_3 = min_current * nominal_voltage * 3 %}

            {% if selected_mode == '1-Phase Minimum' %} {% set desired_phase = 1 %}
            {% elif selected_mode == '3-Phases Minimum' %} {% set desired_phase = 3 %}
            {% elif force_single %} {% set desired_phase = 1 %}
            {% elif adjusted_available_power_final >= (p_min_3 * 0.95) %} {% set desired_phase = 3 %}
            {% else %} {% set desired_phase = 1 %}
            {% endif %}

            {% set current_phase = 3 if states(state_attr('sensor.ev_load_balancer_charger','phases_output')) == phase_3 else 1 %}
            {% if desired_phase > current_phase and states('timer.ev_load_balancer_phase_switching_timer') == 'active' %}
              {{ current_phase }}
            {% else %}
              {{ desired_phase }}
            {% endif %}

          adjusted_current_limit: >
            {% set current = (adjusted_available_power_final / (nominal_voltage * adjusted_phase_selection)) | round(1) %}
            {% if current < min_current %} 0
            {% elif current > max_current %} {{ max_current | float }}
            {% else %} {{ current }}
            {% endif %}

      # --- 9. EXECUTION LOGIC ---
      - choose:
          - conditions:
              - condition: template
                value_template: >
                  {% set base_sensors = [
                    states('sensor.ev_load_balancer_house'),
                    state_attr('sensor.ev_load_balancer_charger','current_input'),
                    state_attr('sensor.ev_load_balancer_charger','active_power'),
                    state_attr('sensor.ev_load_balancer_charger','phases_input'),
                  ] %}
                  {{ base_sensors | select('in', ['unavailable', 'unknown', None, 'none', 'None', '']) | list | count > 0 }}
            sequence:
              - action: system_log.write
                data:
                  level: error
                  message: "[EV Load Balancer] Base sensors unavailable or invalid - fallback to default charger values."
              - action: script.ev_load_balancer_set_charger_params
                metadata: {}
                data:
                  current: "{{ state_attr('sensor.ev_load_balancer_charger','default_current') }}"
                  phase: "{{ state_attr('sensor.ev_load_balancer_charger','default_phases') }}"
                target:
                  entity_id: script.ev_load_balancer_set_charger_params

          - conditions:
              # Catch Off modes and scenarios where Profit/EMS blocked grid AND there is zero sun
              - condition: template
                value_template: "{{ selected_mode in ['Off'] or adjusted_current_limit == 0 }}"
            sequence:
              - action: script.ev_load_balancer_set_charger_params
                metadata: {}
                data:
                  current: 0
                  phase: "{{ state_attr('sensor.ev_load_balancer_charger','default_phases') }}"
                target:
                  entity_id: script.ev_load_balancer_set_charger_params

          - conditions:
              # Active execution for ALL other modes (Fast, Solar, Limited, etc.)
              - condition: template
                value_template: "{{ true }}"
            sequence:
              - action: script.ev_load_balancer_set_charger_params
                metadata: {}
                data:
                  current: "{{ adjusted_current_limit }}"
                  phase: "{{ adjusted_phase_selection }}"
                target:
                  entity_id: script.ev_load_balancer_set_charger_params
    trace:
      stored_traces: 90
    mode: single

  - alias: Reset EV charger
    id: ev_load_balancer_ev_charger_reset
    description: Reset charger when charger is disconnected
    triggers:
      - trigger: template
        value_template: "{{ state_attr('sensor.ev_load_balancer_charger','connection_state') == 'Disconnected' }}"
        for:
          minutes: 1
    action:
      - action: script.ev_load_balancer_set_charger_params
        metadata: {}
        data:
          current: "{{ state_attr('sensor.ev_load_balancer_charger','default_current') }}"
          phase: "{{ state_attr('sensor.ev_load_balancer_charger','default_phases') }}"
        target:
          entity_id: script.ev_load_balancer_set_charger_params
    mode: single

  - alias: Phase Switching Timer Control
    id: ev_load_balancer_phase_switching_timer_control
    description: Start timer when switching from 3 phase to 1 phase in dynamic modes
    triggers:
      - trigger: state
        entity_id: sensor.ev_load_balancer_internal_phase_monitor
    conditions:
      - condition: template
        value_template: >
          {% set phase_1 = state_attr('sensor.ev_load_balancer_charger', 'phase_1_state') | default('1 Phase', true) %}
          {% set phase_3 = state_attr('sensor.ev_load_balancer_charger', 'phase_3_state') | default('3 Phases', true) %}
          {{ trigger.to_state is defined and trigger.to_state.state == phase_1 and 
            (trigger.from_state is not defined or trigger.from_state is none or trigger.from_state.state != phase_1) }}
      - condition: template
        value_template: >
          {{ states('sensor.ev_load_balancer') in ['Limited', 'Solar', 'Comfort'] }}
    actions:
      - action: timer.start
        target:
          entity_id: timer.ev_load_balancer_phase_switching_timer
        data:
          duration: "{{ (state_attr('sensor.ev_load_balancer', 'phase_switch_delay') | int(5)) * 60 }}"
    mode: single
